name: Habit Reminders Cron

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

env:
  CRON_SECRET: ${{ secrets.CRON_SECRET }}
  APP_URL: https://questzen-api-endpoints.vercel.app # Hardcode here

jobs:
  trigger-reminders:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check current time
        run: echo "‚è∞ Running at $(date -u)"

      - name: Trigger Habit Reminders
        run: |
          echo "üöÄ Starting habit reminders cron job..."
          echo "üì° Calling: $APP_URL/api/cron/habit-reminders"

          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$APP_URL/api/cron/habit-reminders")

          body=$(echo "$response" | grep -v HTTP_STATUS)
          http_status=$(echo "$response" | grep HTTP_STATUS | cut -d':' -f2)

          echo "üìä Response Status: $http_status"
          echo "üì¶ Response Body:"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          if [ "$http_status" -ne 200 ]; then
            echo "‚ùå Cron job failed with status: $http_status"
            exit 1
          fi

          echo "‚úÖ Cron job completed successfully"

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Habit Reminders Cron Failed',
              body: `The habit reminders cron job failed at ${new Date().toISOString()}. Please check the workflow run.`,
              labels: ['cron-failure']
            })
