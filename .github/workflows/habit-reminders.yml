name: Habit Reminders Cron

on:
  schedule:
    - cron: "0 6,12,18,21 * * *" # Every 6 hours
  workflow_dispatch: # Allow manual runs

# Remove the "permissions" section or place it correctly

jobs:
  cron:
    runs-on: ubuntu-latest
    permissions:
      issues: write # Place it here, inside the job

    steps:
      - name: Run Habit Reminders
        run: |
          echo "ğŸš€ Starting habit reminders at $(date -u)"

          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "https://questzen-api-endpoints.vercel.app/api/cron/habit-reminders")

          # Separate body and status code
          body=$(echo "$response" | head -n -1)
          status_code=$(echo "$response" | tail -n 1)

          echo "ğŸ“Š HTTP Status: $status_code"
          echo "ğŸ“¦ Response: $body"

          if [ "$status_code" -eq 200 ]; then
            echo "âœ… Cron job completed successfully"
          else
            echo "âŒ Cron job failed"
            exit 1
          fi

      # Now this will work with the correct permissions
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Habit Reminders Cron Failed at ${new Date().toISOString()}`,
              body: `The habit reminders cron job failed.\n\nCheck the logs for details.`,
              labels: ['cron-failure']
            })
